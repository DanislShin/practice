<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Be 동사 활용 연습</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        max-width: 900px;
        margin: auto;
        padding: 20px;
        line-height: 1.6;
        background-color: #f5f5f5;
      }
      button {
        margin: 5px 5px 10px 0;
        padding: 8px 15px;
        background-color: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .sentence-block {
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: white;
        margin-bottom: 15px;
        position: relative;
      }
      .hidden {
        display: none;
      }
      audio {
        display: block;
        margin: 12px 0;
        width: 100%;
      }
      .translation,
      .vocab,
      .furigana {
        margin-top: 10px;
        padding: 12px;
        background: #ffebee;
        border-radius: 6px;
      }
      .furigana {
        background: #e3f2fd;
        color: #0d47a1;
      }
      .checkmark {
        position: absolute;
        right: 15px;
        top: 15px;
        color: #34a853;
        font-size: 20px;
      }
      #micStatus {
        padding: 15px;
        background: #fff3e0;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }
      #micStatus button {
        margin-top: 10px;
        background-color: #fb8c00;
      }
      .permission-info {
        font-size: 0.9em;
        color: #666;
        margin-top: 15px;
      }
      .accuracy-result {
        margin-top: 10px;
        padding: 10px;
        background: #e8f5e9;
        border-radius: 4px;
      }
      #toggleFuriganaBtn {
        background-color: #1976d2;
      }
      .error-analysis {
        margin-top: 10px;
        padding: 10px;
        background: #fff8e1;
        border-radius: 4px;
      }
      .error-char {
        color: red;
        font-weight: bold;
        text-decoration: underline;
      }
      #downloadReportBtn {
        background-color: #388e3c;
      }
      .tense-header {
        background-color: #b71c1c;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin: 20px 0 10px 0;
      }
    </style>
  </head>
  <body>
    <h1 style="color: #b71c1c">Be 동사 활용 연습</h1>
    <div id="micStatus">
      <p>⚠️ 마이크 접근 권한이 필요합니다</p>
      <p>1. 아래 버튼을 클릭하면 권한 요청이 표시됩니다</p>
      <p>2. "허용"을 선택해주세요</p>
      <p>3. <strong>한 번 허용하면 다음부터는 자동으로 인식됩니다</strong></p>
      <button id="permissionButton">마이크 접근 허용</button>
    </div>
    <button onclick="downloadAllRecordings()">
      📥 녹음 파일 일괄 다운로드
    </button>
    <button id="toggleFuriganaBtn" onclick="toggleFurigana()">
      ▼ 해석 보기/숨기기
    </button>
    <button id="downloadReportBtn" onclick="downloadAccuracyReport()">
      📊 정확도 리포트 다운로드
    </button>
    <div class="permission-info">
      ※ 마이크 접근은 이 사이트에서만 사용되며, 음성 데이터는 서버에 저장되지
      않습니다
    </div>
    <div id="content"></div>
    <script>
      // ====== 전역 변수 ======
      let globalStream = null;
      const audioBlobs = [];
      const mediaRecorders = {};
      let permissionGranted =
        localStorage.getItem("micPermissionGranted") === "true";
      const accuracyResults = []; // 정확도 결과 저장

      // Be 동사 예문 데이터
      const sentences = [
        // Present Simple
        {
          en: "I am a student.",
          ko: "나는 학생이다.",
          type: "현재 단순 (신분, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "I am at home.",
          ko: "나는 집에 있다.",
          type: "현재 단순 (장소, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "I am happy.",
          ko: "나는 행복하다.",
          type: "현재 단순 (상태, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "You are a teacher.",
          ko: "너는 교사다.",
          type: "현재 단순 (신분, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "You are in Seoul.",
          ko: "너는 서울에 있다.",
          type: "현재 단순 (장소, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "You are happy.",
          ko: "너는 행복하다.",
          type: "현재 단순 (상태, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is a doctor.",
          ko: "그는/그녀는 의사다.",
          type: "현재 단순 (신분, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is at school.",
          ko: "그는/그녀는 학교에 있다.",
          type: "현재 단순 (장소, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is happy.",
          ko: "그는/그녀는 행복하다.",
          type: "현재 단순 (상태, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "They are friends.",
          ko: "그들은 친구다.",
          type: "현재 단순 (신분, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "They are in Busan.",
          ko: "그들은 부산에 있다.",
          type: "현재 단순 (장소, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "They are happy.",
          ko: "그들은 행복하다.",
          type: "현재 단순 (상태, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "It is sunny.",
          ko: "날씨가 맑다.",
          type: "현재 단순 (날씨, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "It is 7 o’clock.",
          ko: "7시다.",
          type: "현재 단순 (시간, 평서문)",
          tense: "현재 단순",
        },
        {
          en: "Am I a student?",
          ko: "내가 학생이니?",
          type: "현재 단순 (신분, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Am I at home?",
          ko: "내가 집에 있니?",
          type: "현재 단순 (장소, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Am I happy?",
          ko: "내가 행복하니?",
          type: "현재 단순 (상태, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are you a teacher?",
          ko: "너 교사니?",
          type: "현재 단순 (신분, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are you in Seoul?",
          ko: "너 서울에 있니?",
          type: "현재 단순 (장소, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are you happy?",
          ko: "너 행복하니?",
          type: "현재 단순 (상태, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Is he/she a doctor?",
          ko: "그는/그녀는 의사니?",
          type: "현재 단순 (신분, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Is he/she at school?",
          ko: "그는/그녀는 학교에 있니?",
          type: "현재 단순 (장소, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Is he/she happy?",
          ko: "그는/그녀는 행복하니?",
          type: "현재 단순 (상태, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are they friends?",
          ko: "그들은 친구니?",
          type: "현재 단순 (신분, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are they in Busan?",
          ko: "그들은 부산에 있니?",
          type: "현재 단순 (장소, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Are they happy?",
          ko: "그들은 행복하니?",
          type: "현재 단순 (상태, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Is it sunny?",
          ko: "맑니?",
          type: "현재 단순 (날씨, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Is it 7 o’clock?",
          ko: "7시니?",
          type: "현재 단순 (시간, 의문문)",
          tense: "현재 단순",
        },
        {
          en: "Am I not a student?",
          ko: "내가 학생이 아니니?",
          type: "현재 단순 (신분, 의문 부정문)",
          tense: "현재 단순",
        },
        {
          en: "Aren’t you a teacher?",
          ko: "너 교사가 아니니?",
          type: "현재 단순 (신분, 의문 부정문)",
          tense: "현재 단순",
        },
        {
          en: "Isn’t he/she a doctor?",
          ko: "그는/그녀는 의사가 아니니?",
          type: "현재 단순 (신분, 의문 부정문)",
          tense: "현재 단순",
        },
        {
          en: "Aren’t they friends?",
          ko: "그들은 친구가 아니니?",
          type: "현재 단순 (신분, 의문 부정문)",
          tense: "현재 단순",
        },
        {
          en: "Isn’t it sunny?",
          ko: "맑지 않니?",
          type: "현재 단순 (날씨, 의문 부정문)",
          tense: "현재 단순",
        },
        {
          en: "I am not a student.",
          ko: "나는 학생이 아니다.",
          type: "현재 단순 (신분, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "I am not at home.",
          ko: "나는 집에 있지 않다.",
          type: "현재 단순 (장소, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "I am not happy.",
          ko: "나는 행복하지 않다.",
          type: "현재 단순 (상태, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "You are not a teacher.",
          ko: "너는 교사가 아니다.",
          type: "현재 단순 (신분, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "You are not in Seoul.",
          ko: "너는 서울에 있지 않다.",
          type: "현재 단순 (장소, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "You are not happy.",
          ko: "너는 행복하지 않다.",
          type: "현재 단순 (상태, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is not a doctor.",
          ko: "그는/그녀는 의사가 아니다.",
          type: "현재 단순 (신분, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is not at school.",
          ko: "그는/그녀는 학교에 있지 않다.",
          type: "현재 단순 (장소, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "He/She is not happy.",
          ko: "그는/그녀는 행복하지 않다.",
          type: "현재 단순 (상태, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "They are not friends.",
          ko: "그들은 친구가 아니다.",
          type: "현재 단순 (신분, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "They are not in Busan.",
          ko: "그들은 부산에 있지 않다.",
          type: "현재 단순 (장소, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "They are not happy.",
          ko: "그들은 행복하지 않다.",
          type: "현재 단순 (상태, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "It is not sunny.",
          ko: "날씨가 맑지 않다.",
          type: "현재 단순 (날씨, 부정문)",
          tense: "현재 단순",
        },
        {
          en: "It is not 7 o’clock.",
          ko: "7시가 아니다.",
          type: "현재 단순 (시간, 부정문)",
          tense: "현재 단순",
        },
        // Past Simple
        {
          en: "I was a student.",
          ko: "나는 학생이었다.",
          type: "과거 단순 (신분, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "I was at home.",
          ko: "나는 집에 있었다.",
          type: "과거 단순 (장소, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "I was happy.",
          ko: "나는 행복했다.",
          type: "과거 단순 (상태, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "You were a teacher.",
          ko: "너는 교사였다.",
          type: "과거 단순 (신분, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "You were in Seoul.",
          ko: "너는 서울에 있었다.",
          type: "과거 단순 (장소, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "You were happy.",
          ko: "너는 행복했다.",
          type: "과거 단순 (상태, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was a doctor.",
          ko: "그는/그녀는 의사였다.",
          type: "과거 단순 (신분, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was at school.",
          ko: "그는/그녀는 학교에 있었다.",
          type: "과거 단순 (장소, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was happy.",
          ko: "그는/그녀는 행복했다.",
          type: "과거 단순 (상태, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "They were friends.",
          ko: "그들은 친구였다.",
          type: "과거 단순 (신분, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "They were in Busan.",
          ko: "그들은 부산에 있었다.",
          type: "과거 단순 (장소, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "They were happy.",
          ko: "그들은 행복했다.",
          type: "과거 단순 (상태, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "It was sunny.",
          ko: "날씨가 맑았다.",
          type: "과거 단순 (날씨, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "It was 7 o’clock.",
          ko: "7시였다.",
          type: "과거 단순 (시간, 평서문)",
          tense: "과거 단순",
        },
        {
          en: "Was I a student?",
          ko: "내가 학생이었니?",
          type: "과거 단순 (신분, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was I at home?",
          ko: "내가 집에 있었니?",
          type: "과거 단순 (장소, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was I happy?",
          ko: "내가 행복했니?",
          type: "과거 단순 (상태, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were you a teacher?",
          ko: "너 교사였니?",
          type: "과거 단순 (신분, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were you in Seoul?",
          ko: "너 서울에 있었니?",
          type: "과거 단순 (장소, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were you happy?",
          ko: "너 행복했니?",
          type: "과거 단순 (상태, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was he/she a doctor?",
          ko: "그는/그녀는 의사였니?",
          type: "과거 단순 (신분, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was he/she at school?",
          ko: "그는/그녀는 학교에 있었니?",
          type: "과거 단순 (장소, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was he/she happy?",
          ko: "그는/그녀는 행복했니?",
          type: "과거 단순 (상태, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were they friends?",
          ko: "그들은 친구였니?",
          type: "과거 단순 (신분, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were they in Busan?",
          ko: "그들은 부산에 있었니?",
          type: "과거 단순 (장소, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Were they happy?",
          ko: "그들은 행복했니?",
          type: "과거 단순 (상태, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was it sunny?",
          ko: "맑았니?",
          type: "과거 단순 (날씨, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Was it 7 o’clock?",
          ko: "7시였니?",
          type: "과거 단순 (시간, 의문문)",
          tense: "과거 단순",
        },
        {
          en: "Wasn’t I a student?",
          ko: "내가 학생이 아니었니?",
          type: "과거 단순 (신분, 의문 부정문)",
          tense: "과거 단순",
        },
        {
          en: "Weren’t you a teacher?",
          ko: "너 교사가 아니었니?",
          type: "과거 단순 (신분, 의문 부정문)",
          tense: "과거 단순",
        },
        {
          en: "Wasn’t he/she a doctor?",
          ko: "그는/그녀는 의사가 아니었니?",
          type: "과거 단순 (신분, 의문 부정문)",
          tense: "과거 단순",
        },
        {
          en: "Weren’t they friends?",
          ko: "그들은 친구가 아니었니?",
          type: "과거 단순 (신분, 의문 부정문)",
          tense: "과거 단순",
        },
        {
          en: "Wasn’t it sunny?",
          ko: "맑지 않았니?",
          type: "과거 단순 (날씨, 의문 부정문)",
          tense: "과거 단순",
        },
        {
          en: "I was not a student.",
          ko: "나는 학생이 아니었다.",
          type: "과거 단순 (신분, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "I was not at home.",
          ko: "나는 집에 있지 않았다.",
          type: "과거 단순 (장소, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "I was not happy.",
          ko: "나는 행복하지 않았다.",
          type: "과거 단순 (상태, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "You were not a teacher.",
          ko: "너는 교사가 아니었다.",
          type: "과거 단순 (신분, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "You were not in Seoul.",
          ko: "너는 서울에 있지 않았다.",
          type: "과거 단순 (장소, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "You were not happy.",
          ko: "너는 행복하지 않았다.",
          type: "과거 단순 (상태, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was not a doctor.",
          ko: "그는/그녀는 의사가 아니었다.",
          type: "과거 단순 (신분, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was not at school.",
          ko: "그는/그녀는 학교에 있지 않았다.",
          type: "과거 단순 (장소, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "He/She was not happy.",
          ko: "그는/그녀는 행복하지 않았다.",
          type: "과거 단순 (상태, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "They were not friends.",
          ko: "그들은 친구가 아니었다.",
          type: "과거 단순 (신분, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "They were not in Busan.",
          ko: "그들은 부산에 있지 않았다.",
          type: "과거 단순 (장소, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "They were not happy.",
          ko: "그들은 행복하지 않았다.",
          type: "과거 단순 (상태, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "It was not sunny.",
          ko: "날씨가 맑지 않았다.",
          type: "과거 단순 (날씨, 부정문)",
          tense: "과거 단순",
        },
        {
          en: "It was not 7 o’clock.",
          ko: "7시가 아니었다.",
          type: "과거 단순 (시간, 부정문)",
          tense: "과거 단순",
        },
        // Future Simple
        {
          en: "I will be a student.",
          ko: "나는 학생일 것이다.",
          type: "미래 단순 (신분, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "I will be at home.",
          ko: "나는 집에 있을 것이다.",
          type: "미래 단순 (장소, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "I will be happy.",
          ko: "나는 행복할 것이다.",
          type: "미래 단순 (상태, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "You will be a teacher.",
          ko: "너는 교사가 될 것이다.",
          type: "미래 단순 (신분, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "You will be in Seoul.",
          ko: "너는 서울에 있을 것이다.",
          type: "미래 단순 (장소, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "You will be happy.",
          ko: "너는 행복할 것이다.",
          type: "미래 단순 (상태, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "He/She will be a doctor.",
          ko: "그는/그녀는 의사가 될 것이다.",
          type: "미래 단순 (신분, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "He/She will be at school.",
          ko: "그는/그녀는 학교에 있을 것이다.",
          type: "미래 단순 (장소, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "He/She will be happy.",
          ko: "그는/그녀는 행복할 것이다.",
          type: "미래 단순 (상태, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "They will be friends.",
          ko: "그들은 친구가 될 것이다.",
          type: "미래 단순 (신분, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "They will be in Busan.",
          ko: "그들은 부산에 있을 것이다.",
          type: "미래 단순 (장소, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "They will be happy.",
          ko: "그들은 행복할 것이다.",
          type: "미래 단순 (상태, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "It will be sunny.",
          ko: "날씨가 맑을 것이다.",
          type: "미래 단순 (날씨, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "It will be 7 o’clock.",
          ko: "7시가 될 것이다.",
          type: "미래 단순 (시간, 평서문)",
          tense: "미래 단순",
        },
        {
          en: "Will I be a student?",
          ko: "내가 학생일 거니?",
          type: "미래 단순 (신분, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will I be at home?",
          ko: "내가 집에 있을 거니?",
          type: "미래 단순 (장소, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will I be happy?",
          ko: "내가 행복할 거니?",
          type: "미래 단순 (상태, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will you be a teacher?",
          ko: "너 교사가 될 거니?",
          type: "미래 단순 (신분, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will you be in Seoul?",
          ko: "너 서울에 있을 거니?",
          type: "미래 단순 (장소, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will you be happy?",
          ko: "너 행복할 거니?",
          type: "미래 단순 (상태, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will he/she be a doctor?",
          ko: "그는/그녀는 의사가 될 거니?",
          type: "미래 단순 (신분, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will he/she be at school?",
          ko: "그는/그녀는 학교에 있을 거니?",
          type: "미래 단순 (장소, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will he/she be happy?",
          ko: "그는/그녀는 행복할 거니?",
          type: "미래 단순 (상태, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will they be friends?",
          ko: "그들은 친구가 될 거니?",
          type: "미래 단순 (신분, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will they be in Busan?",
          ko: "그들은 부산에 있을 거니?",
          type: "미래 단순 (장소, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will they be happy?",
          ko: "그들은 행복할 거니?",
          type: "미래 단순 (상태, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will it be sunny?",
          ko: "맑을 거니?",
          type: "미래 단순 (날씨, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Will it be 7 o’clock?",
          ko: "7시가 될 거니?",
          type: "미래 단순 (시간, 의문문)",
          tense: "미래 단순",
        },
        {
          en: "Won’t I be a student?",
          ko: "내가 학생이 되지 않을 거니?",
          type: "미래 단순 (신분, 의문 부정문)",
          tense: "미래 단순",
        },
        {
          en: "Won’t you be a teacher?",
          ko: "너 교사가 되지 않을 거니?",
          type: "미래 단순 (신분, 의문 부정문)",
          tense: "미래 단순",
        },
        {
          en: "Won’t he/she be a doctor?",
          ko: "그는/그녀는 의사가 되지 않을 거니?",
          type: "미래 단순 (신분, 의문 부정문)",
          tense: "미래 단순",
        },
        {
          en: "Won’t they be friends?",
          ko: "그들은 친구가 되지 않을 거니?",
          type: "미래 단순 (신분, 의문 부정문)",
          tense: "미래 단순",
        },
        {
          en: "Won’t it be sunny?",
          ko: "맑지 않을 거니?",
          type: "미래 단순 (날씨, 의문 부정문)",
          tense: "미래 단순",
        },
        {
          en: "I won’t be a student.",
          ko: "나는 학생이 되지 않을 것이다.",
          type: "미래 단순 (신분, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "I won’t be at home.",
          ko: "나는 집에 있지 않을 것이다.",
          type: "미래 단순 (장소, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "I won’t be happy.",
          ko: "나는 행복하지 않을 것이다.",
          type: "미래 단순 (상태, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "You won’t be a teacher.",
          ko: "너는 교사가 되지 않을 것이다.",
          type: "미래 단순 (신분, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "You won’t be in Seoul.",
          ko: "너는 서울에 있지 않을 것이다.",
          type: "미래 단순 (장소, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "You won’t be happy.",
          ko: "너는 행복하지 않을 것이다.",
          type: "미래 단순 (상태, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "He/She won’t be a doctor.",
          ko: "그는/그녀는 의사가 되지 않을 것이다.",
          type: "미래 단순 (신분, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "He/She won’t be at school.",
          ko: "그는/그녀는 학교에 있지 않을 것이다.",
          type: "미래 단순 (장소, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "He/She won’t be happy.",
          ko: "그는/그녀는 행복하지 않을 것이다.",
          type: "미래 단순 (상태, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "They won’t be friends.",
          ko: "그들은 친구가 되지 않을 것이다.",
          type: "미래 단순 (신분, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "They won’t be in Busan.",
          ko: "그들은 부산에 있지 않을 것이다.",
          type: "미래 단순 (장소, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "They won’t be happy.",
          ko: "그들은 행복하지 않을 것이다.",
          type: "미래 단순 (상태, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "It won’t be sunny.",
          ko: "날씨가 맑지 않을 것이다.",
          type: "미래 단순 (날씨, 부정문)",
          tense: "미래 단순",
        },
        {
          en: "It won’t be 7 o’clock.",
          ko: "7시가 되지 않을 것이다.",
          type: "미래 단순 (시간, 부정문)",
          tense: "미래 단순",
        },
        // Present Perfect
        {
          en: "I have been a student.",
          ko: "나는 (지금까지) 학생이었다.",
          type: "현재완료 (신분, 평서문)",
          tense: "현재완료",
        },
        {
          en: "I have been at home.",
          ko: "나는 (지금까지) 집에 있었다.",
          type: "현재완료 (장소, 평서문)",
          tense: "현재완료",
        },
        {
          en: "I have been happy.",
          ko: "나는 (지금까지) 행복했다.",
          type: "현재완료 (상태, 평서문)",
          tense: "현재완료",
        },
        {
          en: "You have been a teacher.",
          ko: "너는 (지금까지) 교사였다.",
          type: "현재완료 (신분, 평서문)",
          tense: "현재완료",
        },
        {
          en: "You have been in Seoul.",
          ko: "너는 (지금까지) 서울에 있었다.",
          type: "현재완료 (장소, 평서문)",
          tense: "현재완료",
        },
        {
          en: "You have been happy.",
          ko: "너는 (지금까지) 행복했다.",
          type: "현재완료 (상태, 평서문)",
          tense: "현재완료",
        },
        {
          en: "He/She has been a doctor.",
          ko: "그는/그녀는 (지금까지) 의사였다.",
          type: "현재완료 (신분, 평서문)",
          tense: "현재완료",
        },
        {
          en: "He/She has been at school.",
          ko: "그는/그녀는 (지금까지) 학교에 있었다.",
          type: "현재완료 (장소, 평서문)",
          tense: "현재완료",
        },
        {
          en: "He/She has been happy.",
          ko: "그는/그녀는 (지금까지) 행복했다.",
          type: "현재완료 (상태, 평서문)",
          tense: "현재완료",
        },
        {
          en: "They have been friends.",
          ko: "그들은 (지금까지) 친구였다.",
          type: "현재완료 (신분, 평서문)",
          tense: "현재완료",
        },
        {
          en: "They have been in Busan.",
          ko: "그들은 (지금까지) 부산에 있었다.",
          type: "현재완료 (장소, 평서문)",
          tense: "현재완료",
        },
        {
          en: "They have been happy.",
          ko: "그들은 (지금까지) 행복했다.",
          type: "현재완료 (상태, 평서문)",
          tense: "현재완료",
        },
        {
          en: "It has been sunny.",
          ko: "(지금까지) 맑았다.",
          type: "현재완료 (날씨, 평서문)",
          tense: "현재완료",
        },
        {
          en: "It has been 7 o’clock.",
          ko: "(지금까지) 7시였다.",
          type: "현재완료 (시간, 평서문)",
          tense: "현재완료",
        },
        {
          en: "Have I been a student?",
          ko: "내가 (지금까지) 학생이었니?",
          type: "현재완료 (신분, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have I been at home?",
          ko: "내가 (지금까지) 집에 있었니?",
          type: "현재완료 (장소, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have I been happy?",
          ko: "내가 (지금까지) 행복했니?",
          type: "현재완료 (상태, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have you been a teacher?",
          ko: "너 (지금까지) 교사였니?",
          type: "현재완료 (신분, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have you been in Seoul?",
          ko: "너 (지금까지) 서울에 있었니?",
          type: "현재완료 (장소, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have you been happy?",
          ko: "너 (지금까지) 행복했니?",
          type: "현재완료 (상태, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Has he/she been a doctor?",
          ko: "그는/그녀는 (지금까지) 의사였니?",
          type: "현재완료 (신분, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Has he/she been at school?",
          ko: "그는/그녀는 (지금까지) 학교에 있었니?",
          type: "현재완료 (장소, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Has he/she been happy?",
          ko: "그는/그녀는 (지금까지) 행복했니?",
          type: "현재완료 (상태, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have they been friends?",
          ko: "그들은 (지금까지) 친구였니?",
          type: "현재완료 (신분, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have they been in Busan?",
          ko: "그들은 (지금까지) 부산에 있었니?",
          type: "현재완료 (장소, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Have they been happy?",
          ko: "그들은 (지금까지) 행복했니?",
          type: "현재완료 (상태, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Has it been sunny?",
          ko: "(지금까지) 맑았니?",
          type: "현재완료 (날씨, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Has it been 7 o’clock?",
          ko: "(지금까지) 7시였니?",
          type: "현재완료 (시간, 의문문)",
          tense: "현재완료",
        },
        {
          en: "Haven’t I been a student?",
          ko: "내가 (지금까지) 학생이 아니었니?",
          type: "현재완료 (신분, 의문 부정문)",
          tense: "현재완료",
        },
        {
          en: "Haven’t you been a teacher?",
          ko: "너 (지금까지) 교사가 아니었니?",
          type: "현재완료 (신분, 의문 부정문)",
          tense: "현재완료",
        },
        {
          en: "Hasn’t he/she been a doctor?",
          ko: "그는/그녀는 (지금까지) 의사가 아니었니?",
          type: "현재완료 (신분, 의문 부정문)",
          tense: "현재완료",
        },
        {
          en: "Haven’t they been friends?",
          ko: "그들은 (지금까지) 친구가 아니었니?",
          type: "현재완료 (신분, 의문 부정문)",
          tense: "현재완료",
        },
        {
          en: "Hasn’t it been sunny?",
          ko: "(지금까지) 맑지 않았니?",
          type: "현재완료 (날씨, 의문 부정문)",
          tense: "현재완료",
        },
        {
          en: "I have not been a student.",
          ko: "나는 (지금까지) 학생이 아니었다.",
          type: "현재완료 (신분, 부정문)",
          tense: "현재완료",
        },
        {
          en: "I have not been at home.",
          ko: "나는 (지금까지) 집에 있지 않았다.",
          type: "현재완료 (장소, 부정문)",
          tense: "현재완료",
        },
        {
          en: "I have not been happy.",
          ko: "나는 (지금까지) 행복하지 않았다.",
          type: "현재완료 (상태, 부정문)",
          tense: "현재완료",
        },
        {
          en: "You have not been a teacher.",
          ko: "너는 (지금까지) 교사가 아니었다.",
          type: "현재완료 (신분, 부정문)",
          tense: "현재완료",
        },
        {
          en: "You have not been in Seoul.",
          ko: "너는 (지금까지) 서울에 있지 않았다.",
          type: "현재완료 (장소, 부정문)",
          tense: "현재완료",
        },
        {
          en: "You have not been happy.",
          ko: "너는 (지금까지) 행복하지 않았다.",
          type: "현재완료 (상태, 부정문)",
          tense: "현재완료",
        },
        {
          en: "He/She has not been a doctor.",
          ko: "그는/그녀는 (지금까지) 의사가 아니었다.",
          type: "현재완료 (신분, 부정문)",
          tense: "현재완료",
        },
        {
          en: "He/She has not been at school.",
          ko: "그는/그녀는 (지금까지) 학교에 있지 않았다.",
          type: "현재완료 (장소, 부정문)",
          tense: "현재완료",
        },
        {
          en: "He/She has not been happy.",
          ko: "그는/그녀는 (지금까지) 행복하지 않았다.",
          type: "현재완료 (상태, 부정문)",
          tense: "현재완료",
        },
        {
          en: "They have not been friends.",
          ko: "그들은 (지금까지) 친구가 아니었다.",
          type: "현재완료 (신분, 부정문)",
          tense: "현재완료",
        },
        {
          en: "They have not been in Busan.",
          ko: "그들은 (지금까지) 부산에 있지 않았다.",
          type: "현재완료 (장소, 부정문)",
          tense: "현재완료",
        },
        {
          en: "They have not been happy.",
          ko: "그들은 (지금까지) 행복하지 않았다.",
          type: "현재완료 (상태, 부정문)",
          tense: "현재완료",
        },
        {
          en: "It has not been sunny.",
          ko: "(지금까지) 맑지 않았다.",
          type: "현재완료 (날씨, 부정문)",
          tense: "현재완료",
        },
        {
          en: "It has not been 7 o’clock.",
          ko: "(지금까지) 7시가 아니었다.",
          type: "현재완료 (시간, 부정문)",
          tense: "현재완료",
        },
      ];

      // ====== 해석 표시/숨기기 ======
      function toggleFurigana() {
        const allTranslations = document.querySelectorAll(
          ".translation, .vocab"
        );
        allTranslations.forEach((el) => el.classList.toggle("hidden"));

        const btn = document.getElementById("toggleFuriganaBtn");
        if (btn.textContent.includes("보기")) {
          btn.textContent = "▲ 해석 숨기기";
        } else {
          btn.textContent = "▼ 해석 보기";
        }
      }

      // ====== 음성 인식 정확도 계산 및 오류 분석 ======
      function calculateAccuracy(original, recognized, index) {
        // 특수기호 제거 및 공백 정규화
        const cleanOriginal = original
          .replace(/[.,!?]/g, "")
          .replace(/\s+/g, "");
        const cleanRecognized = recognized
          .replace(/[.,!?]/g, "")
          .replace(/\s+/g, "");

        let matched = 0;
        const minLength = Math.min(
          cleanOriginal.length,
          cleanRecognized.length
        );
        const errorPositions = [];

        for (let i = 0; i < minLength; i++) {
          if (
            cleanOriginal[i].toLowerCase() === cleanRecognized[i].toLowerCase()
          ) {
            matched++;
          } else {
            errorPositions.push(i);
          }
        }

        const accuracy = Math.round((matched / cleanOriginal.length) * 100);

        // 오류 위치를 강조한 HTML 생성
        let highlightedOriginal = "";
        let highlightedRecognized = "";

        for (let i = 0; i < cleanOriginal.length; i++) {
          if (errorPositions.includes(i)) {
            highlightedOriginal += `<span class="error-char">${cleanOriginal[i]}</span>`;
          } else {
            highlightedOriginal += cleanOriginal[i];
          }
        }

        for (
          let i = 0;
          i < Math.min(cleanRecognized.length, cleanOriginal.length);
          i++
        ) {
          if (errorPositions.includes(i)) {
            highlightedRecognized += `<span class="error-char">${cleanRecognized[i]}</span>`;
          } else {
            highlightedRecognized += cleanRecognized[i];
          }
        }

        // 결과 저장
        accuracyResults[index] = {
          original: cleanOriginal,
          recognized: cleanRecognized,
          accuracy: accuracy,
          errorPositions: errorPositions,
          highlightedOriginal: highlightedOriginal,
          highlightedRecognized: highlightedRecognized,
        };

        return accuracy;
      }

      // ====== 정확도 리포트 다운로드 ======
      function downloadAccuracyReport() {
        if (accuracyResults.length === 0) {
          alert("분석 데이터가 없습니다. 먼저 음성 인식을 수행해주세요.");
          return;
        }

        let csvContent = "문장 번호,원문,인식 결과,정확도,오류 위치\n";

        accuracyResults.forEach((result, index) => {
          if (!result) return;

          const errorDetails = result.errorPositions
            .map((pos) => {
              return `위치${pos + 1}: '${result.original[pos]}'→'${
                result.recognized[pos] || "없음"
              }'`;
            })
            .join("; ");

          csvContent += `${index + 1},"${sentences[index].en}","${
            result.recognized
          }",${result.accuracy}%,"${errorDetails}"\n`;
        });

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        saveAs(blob, "be동사_발음_분석_리포트.csv");
      }

      // ====== 음성 인식 기능 ======
      async function startRecognition(index) {
        try {
          const micReady = await initMicrophone();
          if (!micReady) return;

          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
            alert("이 브라우저는 음성 인식을 지원하지 않습니다 (Chrome 권장)");
            return;
          }

          const recognition = new SpeechRecognition();
          recognition.lang = "en-US";
          recognition.interimResults = true;
          recognition.continuous = false;

          const output = document.getElementById(`recognition-${index}`);
          output.innerHTML = "<em>🎙️ 인식 중...</em>";

          recognition.onresult = (event) => {
            let transcript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
              transcript += event.results[i][0].transcript;
            }
            const accuracy = calculateAccuracy(
              sentences[index].en,
              transcript,
              index
            );

            const result = accuracyResults[index];
            output.innerHTML = `
            <div class="accuracy-result">
              <strong>인식 결과:</strong> ${result.highlightedRecognized}<br>
              <strong>정확도:</strong> ${accuracy}%
            </div>
            <div class="error-analysis">
              <strong>원문:</strong> ${result.highlightedOriginal}<br>
              <strong>오류 위치:</strong> ${result.errorPositions.length}개
            </div>
          `;
          };

          recognition.start();
        } catch (error) {
          console.error("음성 인식 오류:", error);
        }
      }

      // ====== 기존 기능들 ======
      async function requestMicrophonePermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          stream.getTracks().forEach((track) => track.stop());
          permissionGranted = true;
          localStorage.setItem("micPermissionGranted", "true");
          document.getElementById("micStatus").style.display = "none";
          return true;
        } catch (error) {
          console.error("마이크 권한 요청 실패:", error);
          return false;
        }
      }

      async function initMicrophone() {
        if (permissionGranted && globalStream) return true;

        try {
          globalStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          permissionGranted = true;
          localStorage.setItem("micPermissionGranted", "true");
          document.getElementById("micStatus").style.display = "none";
          return true;
        } catch (error) {
          console.error("마이크 접근 오류:", error);
          document.getElementById("micStatus").style.display = "block";
          return false;
        }
      }

      function playTTS(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "en-US";
        utter.rate = 0.5;
        speechSynthesis.speak(utter);
      }

      async function startRecording(index) {
        const micReady = await initMicrophone();
        if (!micReady) return;

        if (mediaRecorders[index]?.state === "recording") {
          mediaRecorders[index].stop();
        }

        const recorder = new MediaRecorder(globalStream);
        const chunks = [];

        recorder.ondataavailable = (e) => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          const audioURL = URL.createObjectURL(blob);
          const audioElement = document.getElementById(`audio-${index}`);

          audioElement.src = audioURL;
          audioBlobs[index] = blob;
          document.getElementById(`check-${index}`).innerText = "✅";
        };

        mediaRecorders[index] = recorder;
        recorder.start();
      }

      function stopRecording(index) {
        if (mediaRecorders[index]?.state === "recording") {
          mediaRecorders[index].stop();
        }
      }

      function toggle(id) {
        const el = document.getElementById(id);
        el.classList.toggle("hidden");
      }

      function downloadAllRecordings() {
        const zip = new JSZip();
        let hasRecordings = false;

        audioBlobs.forEach((blob, index) => {
          if (blob) {
            const filename = `be_verb_${index + 1}.webm`;
            zip.file(filename, blob);
            hasRecordings = true;
          }
        });

        if (hasRecordings) {
          zip.generateAsync({ type: "blob" }).then((content) => {
            saveAs(content, "be_verb_recordings.zip");
          });
        } else {
          alert("녹음 파일이 없습니다");
        }
      }

      function renderContent() {
        const container = document.getElementById("content");
        let currentTense = "";

        sentences.forEach((sentence, index) => {
          // 시제별 헤더 추가
          if (sentence.tense !== currentTense) {
            currentTense = sentence.tense;
            const header = document.createElement("h3");
            header.className = "tense-header";
            header.textContent = currentTense;
            container.appendChild(header);
          }

          const div = document.createElement("div");
          div.className = "sentence-block";
          div.innerHTML = `
          <span id="check-${index}" class="checkmark"></span>
          <p><strong>${sentence.en
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")}</strong> <small>(${
            sentence.type
          })</small></p>
          <div>
            <button onclick="playTTS('${sentence.en.replace(
              /'/g,
              "\\'"
            )}')">▶️ 듣기</button>
            <button onclick="startRecording(${index})">🎙️ 녹음</button>
            <button onclick="stopRecording(${index})">⏹️ 정지</button>
            <button onclick="toggle('trans-${index}')">🔍 해석 보기</button>
            <button onclick="startRecognition(${index})">🗣️ 발음 체크</button>
          </div>
          <audio id="audio-${index}" controls></audio>
          <div id="recognition-${index}" style="margin-top:10px;"></div>
          <div id="trans-${index}" class="hidden">
            <div class="translation"><strong>한국어:</strong> ${
              sentence.ko
            }</div>
          </div>
        `;
          container.appendChild(div);
        });
      }

      // ====== 초기화 ======
      document
        .getElementById("permissionButton")
        .addEventListener("click", async () => {
          await requestMicrophonePermission();
        });

      window.addEventListener("load", () => {
        if (permissionGranted) {
          document.getElementById("micStatus").style.display = "none";
        } else {
          document.getElementById("micStatus").style.display = "block";
        }
        renderContent();
      });

      window.addEventListener("beforeunload", () => {
        if (globalStream) {
          globalStream.getTracks().forEach((track) => track.stop());
        }
      });
    </script>
  </body>
</html>
